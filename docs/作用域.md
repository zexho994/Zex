# 作用域

## 作用域示例

```java
// GlobalScope
int a = 1;
{  // BlockScope
 int b = 2;
}
int c = a;  //success
int d = b;  //failure
```

## 作用域的本质

变量引用消解:

- 给每个符号设置一个标记，标记的作用是可以知道该符号处于什么范围

## 目标

1. 可以获取某个作用域下所有变量
2. 可以判断作用域的层级关系
3. 可以通过某个作用域找到父级作用域，因为父级作用域的元素依然可以使用

### 如何获取某个作用域下所有变量

正向关联:
Scope 类下存储所有变量

### 如何判断变量处于哪个作用域？

反向关联:
保存 变量->作用域的关联关系

已知信息：变量名
方法一：使用 map 保存所有变量信息
map(var_name,Scope)
通过变量名去获取该变量的作用域？

- 变量名在一个全局块中是唯一的

## 作用域类型

- 全局域(GlobalScope):在进入 prog statement 后,初始化一个全局域,保存全局变量。
- 临时域(LocalScope):临时变量域，保存局部变量和形参。
  - 块域(BlockScope): 在进入 block statement 后,创建一个块域

![域图](https://tva1.sinaimg.cn/large/008i3skNgy1gs3l4wymszj30ey07fq41.jpg)

```java
// 表示域的抽象类
class Scope{
	// 域名，需要全局唯一
	String name;
	// 指向上层域
	Scope parent;
	// 存储改域下所有变量
	List<String> variable_table;
}
```

```java
abstract public class Scope {
	protected List<LocalScope> children;
}

public class GlobalScope extends Scope {
	protected Map<String, Entity> entities;
	protected List<DefinedVariable> staticLocalVariables;
}

public class LocalScope extends Scope {// cache
	protected Scope parent;
	protected Map<String, DefinedVariable> variables;
}
```

> 像 Scope 这样管理变量的称为符号表(Symbol table),将变量这些元素都统称为符号

## 符号表示

```java
class Symbol{

}

//表示变量
class Variable extends Symbol{
	// 用于标识序号,用于处理变量顺序问题
	int id;
	// 变量名
	String name;
	// 变量值
	String data;
	// 所属作用域
	Scope scope;
	// 关联ast节点
	AstNode node
}
```

### 作用域运作流程

总体可以分为 3 部分：

1. 创建 Scope 对象,push to stack
2. 执行处理流程
3. 保存变量信息,然后 pop

```java
// 代码起点,创建一个全局域

int a = 1;  //创建一个变量对象a,加入到GlobalScope中,id=1

{      //创建一个块域

 int b = 2; //创建一个变量对象b,b加入到BlockScope中,id=2

}	  //块域作用消失

int c = a;  //创建一个变量对象c,加入到GlobalScope中,id=3

// 代码终点,全局域作用消失
```

### 创建退出时机

globalScope 创建：在遇到 program 节点是。
globalScope 退出：在 program 节点退出后，域也退出。

blockScope 创建：在遇到 blockStm 节点后
blockScope 退出：在 blockStm 退出后，blockScope 也退出

### 如何知道变量添加到哪个域中

以 blockScope 为例，

方法一[可行]
使用栈,scope 参数，代表当前的域

- 在进入 blockScope 时: push(blockScope)
- 在退出 blockScope 时: stack pop

```java
class Scope{
	scopeStack Stack;  //stack top is the scope of current
}
```

同时将作用域以及生命周期两部分都包括了。
